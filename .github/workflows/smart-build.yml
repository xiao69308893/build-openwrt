# OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ - ä¼˜åŒ–ç‰ˆæœ¬
# æ”¯æŒé€šè¿‡Webç•Œé¢è§¦å‘çš„è‡ªåŠ¨åŒ–ç¼–è¯‘ï¼Œè§£å†³Ubuntu 20.04å¼ƒç”¨é—®é¢˜

name: ğŸ› ï¸ OpenWrt æ™ºèƒ½ç¼–è¯‘

on:
  # æ”¯æŒé€šè¿‡Repository Dispatchè§¦å‘ï¼ˆæ¥è‡ªWebç•Œé¢ï¼‰
  repository_dispatch:
    types: [web_build]
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "lede-master"
        type: choice
        options:
          - openwrt-main
          - lede-master
          - immortalwrt-master
          - Lienol-master
      
      target_device:
        description: "ç›®æ ‡è®¾å¤‡"
        required: true
        default: "x86_64"
        type: choice
        options:
          - x86_64
          - xiaomi_4a_gigabit
          - newifi_d2
          - rpi_4b
          - nanopi_r2s
      
      plugins_list:
        description: "æ’ä»¶åˆ—è¡¨(ç”¨é€—å·åˆ†éš”)"
        required: false
        default: ""
        type: string
      
      build_description:
        description: "ç¼–è¯‘æè¿°"
        required: false
        default: "æ™ºèƒ½ç¼–è¯‘"
        type: string

# ç¯å¢ƒå˜é‡é…ç½®
env:
  TZ: Asia/Shanghai

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šè§£æé…ç½®å’Œè®¾ç½®ç¯å¢ƒ
  prepare:
    runs-on: ubuntu-24.04  # è§£å†³Ubuntu 20.04å¼ƒç”¨é—®é¢˜ï¼Œå‡çº§åˆ°24.04
    name: ğŸ“‹ é…ç½®è§£æ
    outputs:
      source_branch: ${{ steps.config.outputs.source_branch }}
      target_device: ${{ steps.config.outputs.target_device }}
      plugins_list: ${{ steps.config.outputs.plugins_list }}
      build_tag: ${{ steps.config.outputs.build_tag }}
      repo_url: ${{ steps.config.outputs.repo_url }}
      repo_branch: ${{ steps.config.outputs.repo_branch }}
      device_profile: ${{ steps.config.outputs.device_profile }}
      source_name: ${{ steps.config.outputs.source_name }}
      device_name: ${{ steps.config.outputs.device_name }}
      feeds_conf: ${{ steps.config.outputs.feeds_conf }}
      config_file: ${{ steps.config.outputs.config_file }}

      
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
      
      - name: âš™ï¸ è§£æç¼–è¯‘é…ç½®
        id: config
        run: |
          # ä¼˜å…ˆä½¿ç”¨Repository Dispatchçš„é…ç½®ï¼Œå…¶æ¬¡ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸŒ æ£€æµ‹åˆ°Webç•Œé¢è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device }}"
            PLUGINS_LIST="${{ github.event.client_payload.plugins }}"
            BUILD_DESC="Webç•Œé¢ç¼–è¯‘"
          else
            echo "ğŸ–±ï¸ æ£€æµ‹åˆ°æ‰‹åŠ¨è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS_LIST="${{ github.event.inputs.plugins_list }}"
            BUILD_DESC="${{ github.event.inputs.build_description }}"
          fi
          
          # è®¾ç½®é»˜è®¤å€¼
          SOURCE_BRANCH=${SOURCE_BRANCH:-"lede-master"}
          TARGET_DEVICE=${TARGET_DEVICE:-"x86_64"}
          PLUGINS_LIST=${PLUGINS_LIST:-""}
          BUILD_DESC=${BUILD_DESC:-"æ™ºèƒ½ç¼–è¯‘"}
          
          echo "ğŸ“‹ ç¼–è¯‘é…ç½®ä¿¡æ¯:"
          echo "  æºç åˆ†æ”¯: $SOURCE_BRANCH"
          echo "  ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "  æ’ä»¶åˆ—è¡¨: $PLUGINS_LIST"
          echo "  ç¼–è¯‘æè¿°: $BUILD_DESC"
          
          # æ ¹æ®æºç åˆ†æ”¯è®¾ç½®ä»“åº“ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶è·¯å¾„
          case $SOURCE_BRANCH in
            "openwrt-main")
              REPO_URL="https://github.com/openwrt/openwrt"
              REPO_BRANCH="main"
              SOURCE_NAME="OpenWrtå®˜æ–¹"
              FEEDS_CONF="config/openwrt-main/feeds.conf.default"
              CONFIG_FILE="config/openwrt-main/config"

              ;;
            "lede-master")
              REPO_URL="https://github.com/coolsnowwolf/lede"
              REPO_BRANCH="master"
              SOURCE_NAME="Lean's LEDE"
              FEEDS_CONF="config/lede-master/feeds.conf.default"
              CONFIG_FILE="config/lede-master/config"

              ;;
            "immortalwrt-master")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              REPO_BRANCH="master"
              SOURCE_NAME="ImmortalWrt"
              FEEDS_CONF="config/immortalwrt-master/feeds.conf.default"
              CONFIG_FILE="config/immortalwrt-master/config"

              ;;
            "Lienol-master")
              REPO_URL="https://github.com/Lienol/openwrt"
              REPO_BRANCH="22.03"
              SOURCE_NAME="Lienol"
              FEEDS_CONF="config/Lienol-master/feeds.conf.default"
              CONFIG_FILE="config/Lienol-master/config"

              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: $SOURCE_BRANCH"
              exit 1
              ;;
          esac
          
          # æ ¹æ®ç›®æ ‡è®¾å¤‡è®¾ç½®é…ç½®ä¿¡æ¯
          case $TARGET_DEVICE in
            "x86_64")
              DEVICE_PROFILE="x86/64"
              TARGET_SYSTEM="x86_64"
              DEVICE_NAME="X86_64"
              ;;
            "xiaomi_4a_gigabit")
              DEVICE_PROFILE="ramips/mt7621"
              TARGET_SYSTEM="ramips"
              DEVICE_NAME="å°ç±³4Aåƒå…†ç‰ˆ"
              ;;
            "newifi_d2")
              DEVICE_PROFILE="ramips/mt7621"
              TARGET_SYSTEM="ramips"
              DEVICE_NAME="æ–°è·¯ç”±3"
              ;;
            "rpi_4b")
              DEVICE_PROFILE="bcm27xx/bcm2711"
              TARGET_SYSTEM="bcm27xx"
              DEVICE_NAME="æ ‘è“æ´¾4B"
              ;;
            "nanopi_r2s")
              DEVICE_PROFILE="rockchip/armv8"
              TARGET_SYSTEM="rockchip"
              DEVICE_NAME="NanoPi_R2S"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
              exit 1
              ;;
          esac
          
          # ç”Ÿæˆæ„å»ºæ ‡ç­¾
          BUILD_TAG="OpenWrt_${SOURCE_NAME// /_}_${DEVICE_NAME}_$(date +%Y%m%d_%H%M%S)"
          
          # è¾“å‡ºé…ç½®åˆ°ç¯å¢ƒå˜é‡
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_device=$TARGET_DEVICE" >> $GITHUB_OUTPUT
          echo "plugins_list=$PLUGINS_LIST" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "repo_branch=$REPO_BRANCH" >> $GITHUB_OUTPUT
          echo "device_profile=$DEVICE_PROFILE" >> $GITHUB_OUTPUT
          echo "source_name=$SOURCE_NAME" >> $GITHUB_OUTPUT
          echo "device_name=$DEVICE_NAME" >> $GITHUB_OUTPUT
          echo "feeds_conf=$FEEDS_CONF" >> $GITHUB_OUTPUT
          echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT

          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ,é…ç½®è§£æå®Œæˆ"
  # ç¼–è¯‘é˜¶æ®µï¼šå®é™…çš„å›ºä»¶ç¼–è¯‘è¿‡ç¨‹
  build:
    runs-on: ubuntu-24.04  # è§£å†³Ubuntu 20.04å¼ƒç”¨é—®é¢˜
    needs: prepare
    name: ğŸ”¨ å›ºä»¶ç¼–è¯‘
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}  # å®‰å…¨æ£€æŸ¥
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸš€ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ”§ å¼€å§‹åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          echo "ğŸ“‹ ç³»ç»Ÿä¿¡æ¯:"
          lsb_release -a
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´:"
          df -h
          
          # æ¸…ç†Dockeré•œåƒå’Œä¸å¿…è¦æ–‡ä»¶é‡Šæ”¾ç©ºé—´
          echo "ğŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´..."
          docker rmi $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null || true
          
          # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo -E apt-get update
          
          # æ¸…ç†ä¸å¿…è¦çš„è½¯ä»¶åŒ… (æ›´å®‰å…¨çš„æ–¹å¼)
          echo "ğŸ—‘ï¸ æ¸…ç†ä¸å¿…è¦çš„è½¯ä»¶åŒ…..."
          sudo -E apt-get remove --purge azure-cli -y || true
          sudo -E apt-get remove --purge firefox -y || true
          sudo -E apt-get remove --purge powershell -y || true
          sudo -E apt-get remove --purge thunderbird -y || true
          sudo -E apt-get remove --purge libreoffice* -y || true
          
          # åˆ†ç»„å®‰è£…ä¾èµ–åŒ…ä»¥æé«˜æˆåŠŸç‡
          echo "ğŸ“¦ å®‰è£…æ ¸å¿ƒæ„å»ºå·¥å…·..."
          sudo -E apt-get install -y \
            build-essential \
            cmake \
            autoconf \
            automake \
            libtool \
            pkg-config \
            bison \
            flex \
            ccache \
            git \
            curl \
            wget \
            rsync \
            unzip \
            bzip2 \
            gzip \
            tar \
            patch \
            gettext \
            file \
            time || echo "âš ï¸ æŸäº›æ ¸å¿ƒå·¥å…·å®‰è£…å¤±è´¥ï¼Œä½†å¯èƒ½ä¸å½±å“ç¼–è¯‘"
          
          echo "ğŸ“š å®‰è£…å¼€å‘åº“..."
          sudo -E apt-get install -y \
            libncurses5-dev \
            libncursesw5-dev \
            zlib1g-dev \
            libssl-dev \
            libelf-dev \
            libfuse-dev \
            libglib2.0-dev \
            libgmp3-dev \
            libltdl-dev \
            libmpc-dev \
            libmpfr-dev \
            libreadline-dev \
            gnutls-dev || echo "âš ï¸ æŸäº›å¼€å‘åº“å®‰è£…å¤±è´¥ï¼Œä½†å¯èƒ½ä¸å½±å“ç¼–è¯‘"
          
          echo "ğŸ å®‰è£…Pythonç¯å¢ƒ..."
          sudo -E apt-get install -y \
            python3 \
            python3-dev \
            python3-pip \
            python3-setuptools \
            python3-wheel || echo "âš ï¸ Pythonç¯å¢ƒå®‰è£…å¯èƒ½ä¸å®Œæ•´"
          
          # å°è¯•å®‰è£…Pythonç›¸å…³åŒ…ï¼ˆå¯èƒ½åœ¨æŸäº›ç¯å¢ƒä¸­ä¸å¯ç”¨ï¼‰
          sudo -E apt-get install -y \
            python3-ply \
            python3-docutils \
            python3-pyelftools \
            python3-distutils 2>/dev/null || echo "âš ï¸ æŸäº›PythonåŒ…ä¸å¯ç”¨ï¼Œå°†è·³è¿‡"
          
          echo "ğŸ› ï¸ å®‰è£…OpenWrtç‰¹å®šå·¥å…·..."
          sudo -E apt-get install -y \
            gawk \
            asciidoc \
            binutils \
            device-tree-compiler \
            fastjar \
            help2man \
            intltool \
            mkisofs \
            scons \
            subversion \
            xmlto \
            xsltproc \
            qemu-utils \
            squashfs-tools \
            swig \
            yasm \
            p7zip \
            p7zip-full || echo "âš ï¸ æŸäº›OpenWrtå·¥å…·å®‰è£…å¤±è´¥ï¼Œä½†å¯èƒ½ä¸å½±å“ç¼–è¯‘"
          
          # å°è¯•å®‰è£…å¯èƒ½ä¸å¯ç”¨çš„åŒ…
          echo "ğŸ”§ å°è¯•å®‰è£…é¢å¤–å·¥å…·..."
          sudo -E apt-get install -y \
            antlr3 \
            ecj \
            uglifyjs \
            ninja-build \
            lrzsz \
            msmtp 2>/dev/null || echo "âš ï¸ æŸäº›é¢å¤–å·¥å…·ä¸å¯ç”¨ï¼Œå°†è·³è¿‡"
          
          # å°è¯•å®‰è£…å¤šæ¶æ„æ”¯æŒï¼ˆå¯èƒ½åœ¨æŸäº›ç¯å¢ƒä¸­ä¸å¯ç”¨ï¼‰
          echo "ğŸ—ï¸ å°è¯•å®‰è£…å¤šæ¶æ„æ”¯æŒ..."
          sudo -E apt-get install -y \
            gcc-multilib \
            g++-multilib \
            libc6-dev-i386 2>/dev/null || echo "âš ï¸ å¤šæ¶æ„æ”¯æŒä¸å¯ç”¨ï¼Œå°†è·³è¿‡"
          
          # å®‰è£…Node.jsï¼ˆç”¨äºæŸäº›æ„å»ºå·¥å…·ï¼‰
          echo "ğŸ“± å®‰è£…Node.js..."
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - || echo "âš ï¸ Node.jsæºæ·»åŠ å¤±è´¥"
            sudo -E apt-get install -y nodejs || echo "âš ï¸ Node.jså®‰è£…å¤±è´¥"
          fi
          
          # å¦‚æœuglifyjsä¸å¯ç”¨ï¼Œå°è¯•é€šè¿‡npmå®‰è£…
          if ! command -v uglifyjs &> /dev/null && command -v npm &> /dev/null; then
            echo "ğŸ“¦ é€šè¿‡npmå®‰è£…uglifyjs..."
            sudo npm install -g uglify-js || echo "âš ï¸ npmå®‰è£…uglifyjså¤±è´¥"
          fi
          
          # ç³»ç»Ÿæ¸…ç†
          echo "ğŸ§¹ æ¸…ç†ç³»ç»Ÿ..."
          sudo -E systemctl daemon-reload
          sudo -E apt-get autoremove --purge -y
          sudo -E apt-get autoclean
          sudo -E apt-get clean
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          echo "ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•..."
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          # è®¾ç½®æ—¶åŒº
          echo "ğŸ•’ è®¾ç½®æ—¶åŒº..."
          sudo timedatectl set-timezone "$TZ"
          
          # éªŒè¯å…³é”®å·¥å…·
          echo "âœ… éªŒè¯ç¼–è¯‘ç¯å¢ƒ..."
          echo "GCCç‰ˆæœ¬: $(gcc --version | head -1)"
          echo "Makeç‰ˆæœ¬: $(make --version | head -1)"
          echo "Gitç‰ˆæœ¬: $(git --version)"
          echo "Pythonç‰ˆæœ¬: $(python3 --version)"
          echo "CMakeç‰ˆæœ¬: $(cmake --version | head -1 2>/dev/null || echo 'æœªå®‰è£…')"
          
          # æ˜¾ç¤ºæœ€ç»ˆçš„ç£ç›˜ç©ºé—´
          echo "ğŸ’¾ æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ, ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
      - name: ğŸ“¦ å…‹éš†æºç 
        id: codes
        working-directory: /workdir
        if: steps.init.outputs.status == 'success' && !cancelled()
        run: |
          echo "ğŸ“¦ å¼€å§‹å…‹éš†æºç ..."
          echo "  ä»“åº“: ${{ needs.prepare.outputs.repo_url }}"
          echo "  åˆ†æ”¯: ${{ needs.prepare.outputs.repo_branch }}"
          
          # æ˜¾ç¤ºç£ç›˜ç©ºé—´
          df -hT $PWD
          
          # å…‹éš†æºç ï¼ˆåªå…‹éš†æœ€æ–°æäº¤ä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´ï¼‰
          git clone -q --single-branch --depth=1 --branch=${{ needs.prepare.outputs.repo_branch }} ${{ needs.prepare.outputs.repo_url }} openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… æºç å…‹éš†å®Œæˆ"
      - name: ğŸ”§ åŠ è½½è‡ªå®šä¹‰feeds
        run: |
          echo "ğŸ”§ é…ç½®è‡ªå®šä¹‰feeds..."
          
          # å¦‚æœå­˜åœ¨å¯¹åº”åˆ†æ”¯çš„feedsé…ç½®æ–‡ä»¶åˆ™ä½¿ç”¨
          if [ -f "${{ needs.prepare.outputs.feeds_conf }}" ]; then
            cp -f ${{ needs.prepare.outputs.feeds_conf }} openwrt/feeds.conf.default
            echo "ğŸ“‹ ä½¿ç”¨è‡ªå®šä¹‰feedsé…ç½®: ${{ needs.prepare.outputs.feeds_conf }}"
          else
            echo "ğŸ“‹ ä½¿ç”¨é»˜è®¤feedsé…ç½®"
          fi

      - name: ğŸ“¥ æ›´æ–°feeds
        run: |
          echo "ğŸ“¥ å¼€å§‹æ›´æ–°feeds..."
          cd openwrt/
          ./scripts/feeds update -a
          echo "âœ… feedsæ›´æ–°å®Œæˆ"
      - name: ğŸ“¦ å®‰è£…feeds
        run: |
          echo "ğŸ“¦ å¼€å§‹å®‰è£…feeds..."
          cd openwrt/
          ./scripts/feeds install -a
          echo "âœ… feedså®‰è£…å®Œæˆ"
      - name: ğŸ”§ ç”Ÿæˆæœ€ç»ˆç¼–è¯‘é…ç½®
        run: |
          echo "ğŸ”§ å¼€å§‹ç”Ÿæˆæœ€ç»ˆç¼–è¯‘é…ç½®..."
          cd openwrt
          
          # è®¾å¤‡æ¨èæ’ä»¶
          RECOMMEND_PLUGINS=""
          case "${{ needs.prepare.outputs.target_device }}" in
            "x86_64")
              echo "ç”Ÿæˆx86_64åŸºç¡€é…ç½®..."
              cat > .config << 'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_GRUB_IMAGES=y
          CONFIG_GRUB_EFI_IMAGES=y
          EOF
              RECOMMEND_PLUGINS="luci kmod-e1000 kmod-igb"
              ;;
            "xiaomi_4a_gigabit"|"newifi_d2")
              RECOMMEND_PLUGINS="luci kmod-mt76 kmod-usb2"
              ;;
            "rpi_4b")
              RECOMMEND_PLUGINS="luci kmod-usb3 kmod-sound-core kmod-fs-ext4"
              ;;
            "nanopi_r2s")
              RECOMMEND_PLUGINS="luci kmod-usb-net-rtl8152"
              ;;
            *)
              RECOMMEND_PLUGINS="luci"
              ;;
          esac
          # åˆå¹¶ç”¨æˆ·æ’ä»¶å’Œæ¨èæ’ä»¶ï¼Œå»é‡
          PLUGINS="${{ needs.prepare.outputs.plugins_list }}"
          ALL_PLUGINS="$RECOMMEND_PLUGINS $PLUGINS"
          # å»é‡
          ALL_PLUGINS=$(echo $ALL_PLUGINS | tr ' ' '\n' | sort | uniq | tr '\n' ' ')
          if [ -n "$ALL_PLUGINS" ]; then
            echo "ğŸ”§ é…ç½®é€‰ä¸­çš„æ’ä»¶..."
            for plugin in $ALL_PLUGINS; do
              plugin=$(echo "$plugin" | xargs)  # å»é™¤ç©ºæ ¼
              if [ -n "$plugin" ]; then
                echo "CONFIG_PACKAGE_$plugin=y" >> .config
                echo "  âœ“ æ·»åŠ æ’ä»¶: $plugin"
              fi
            done
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make defconfig
          
          echo "ğŸ“‹ æœ€ç»ˆé…ç½®æ–‡ä»¶é¢„è§ˆï¼š"
          cat .config | grep -E "^CONFIG_TARGET|^CONFIG_PACKAGE.*=y" | head -20
          
          echo "âœ… ç¼–è¯‘é…ç½®ç”Ÿæˆå®Œæˆ"
      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
        id: package
        run: |
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"
      - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd openwrt
          
          echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
          # ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥æ—¶é™çº§åˆ°å•çº¿ç¨‹
          make -j$(nproc) V=s || make -j1 || make -j1 V=s
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"
      - name: ğŸ“Š æ£€æŸ¥ç©ºé—´ä½¿ç”¨
        if: (!cancelled())
        run: |
          echo "ğŸ“Š æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ..."
          df -hT
      - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          echo "ğŸ“¦ å¼€å§‹æ•´ç†ç¼–è¯‘äº§ç‰©..."
          cd openwrt/bin/targets/*/*
          
          # åˆ é™¤packagesç›®å½•ä»¥èŠ‚çœç©ºé—´
          rm -rf packages
          
          # è®¡ç®—å›ºä»¶å¤§å°
          FIRMWARE_SIZE=$(du -sh . | cut -f1)
          echo "FIRMWARE_SIZE=$FIRMWARE_SIZE" >> $GITHUB_ENV
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶
          for file in *; do
            if [[ "$file" == *.bin ]] || [[ "$file" == *.img ]] || [[ "$file" == *.gz ]]; then
              # æå–æ–‡ä»¶æ‰©å±•å
              EXT="${file##*.}"
              # ç”Ÿæˆæ–°æ–‡ä»¶å
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              # æ¸…ç†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦
              SOURCE_CLEAN=$(echo "${{ needs.prepare.outputs.source_name }}" | sed 's/[^a-zA-Z0-9]/_/g')
              DEVICE_CLEAN=$(echo "${{ needs.prepare.outputs.device_name }}" | sed 's/[^a-zA-Z0-9]/_/g')
              NEW_NAME="OpenWrt_${SOURCE_CLEAN}_${DEVICE_CLEAN}_${TIMESTAMP}.${EXT}"
              mv "$file" "$NEW_NAME"
              echo "ğŸ“¦ é‡å‘½å: $file -> $NEW_NAME"
            fi
          done
          
          # ç”Ÿæˆè¯¦ç»†çš„å›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cat > firmware_info.txt << EOF
          OpenWrt æ™ºèƒ½ç¼–è¯‘å›ºä»¶ä¿¡æ¯
          ========================
          
          ğŸ“‹ åŸºæœ¬ä¿¡æ¯:
          ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          æ„å»ºæ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}
          æºç åˆ†æ”¯: ${{ needs.prepare.outputs.source_name }}
          ç›®æ ‡è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}
          å›ºä»¶å¤§å°: ${FIRMWARE_SIZE}
          
          ğŸ”§ ç¼–è¯‘é…ç½®:
          é€‰ä¸­æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}
          è®¾å¤‡é…ç½®: ${{ needs.prepare.outputs.device_profile }}
          
          ğŸ“± é»˜è®¤ä¿¡æ¯:
          - é»˜è®¤IPåœ°å€: 192.168.1.1
          - é»˜è®¤ç”¨æˆ·å: root
          - é»˜è®¤å¯†ç : password
          - é»˜è®¤WiFiå: OpenWrt (å¦‚æ”¯æŒ)
          - é»˜è®¤WiFiå¯†ç : æ— 
          
          ğŸ“– ä½¿ç”¨è¯´æ˜:
          1. åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡å‹å·å’Œç¡¬ä»¶ç‰ˆæœ¬
          2. å»ºè®®å…ˆå¤‡ä»½åŸå‚å›ºä»¶
          3. åˆ·æœºæœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œ
          4. å¦‚é‡é—®é¢˜å¯å°è¯•æ•‘ç –æ“ä½œ
          
          ğŸ”— ç›¸å…³é“¾æ¥:
          - é¡¹ç›®åœ°å€: https://github.com/${{ github.repository }}
          - OpenWrtå®˜ç½‘: https://openwrt.org
          - ä½¿ç”¨æ–‡æ¡£: https://github.com/${{ github.repository }}/wiki
          
          âš ï¸ å…è´£å£°æ˜:
          æœ¬å›ºä»¶ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…åˆ·æœºé£é™©ã€‚
          EOF
          
          # ç”ŸæˆSHA256æ ¡éªŒæ–‡ä»¶
          for file in OpenWrt_*.bin OpenWrt_*.img OpenWrt_*.gz; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> sha256sums.txt
              echo "ğŸ”’ ç”Ÿæˆæ ¡éªŒ: $file"
            fi
          done
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ç¼–è¯‘äº§ç‰©æ•´ç†å®Œæˆ"
      - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
        if: steps.organize.outputs.status == 'success'
        with:
          name: ${{ needs.prepare.outputs.build_tag }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 7

      - name: ğŸ‰ ç”Ÿæˆå‘å¸ƒç‰ˆæœ¬
        id: release
        if: steps.organize.outputs.status == 'success'
        run: |
          RELEASE_TAG="${{ needs.prepare.outputs.build_tag }}"
          RELEASE_NAME="OpenWrt æ™ºèƒ½ç¼–è¯‘ - ${{ needs.prepare.outputs.device_name }} ($(date '+%Y-%m-%d %H:%M'))"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
          echo "æ ‡ç­¾: $RELEASE_TAG"
          echo "åç§°: $RELEASE_NAME"
      - name: ğŸ“¢ å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v2  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
        if: steps.release.outputs.release_tag != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release.outputs.release_tag }}
          name: ${{ steps.release.outputs.release_name }}
          body_path: ${{ env.FIRMWARE_PATH }}/firmware_info.txt
          files: |
            ${{ env.FIRMWARE_PATH }}/OpenWrt_*
            ${{ env.FIRMWARE_PATH }}/sha256sums.txt
          draft: false
          prerelease: false

      - name: ğŸ“Š ç¼–è¯‘å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ OpenWrtæ™ºèƒ½ç¼–è¯‘ä»»åŠ¡å®Œæˆ!"
          echo "ğŸ“¦ å›ºä»¶ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_name }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}"
          echo "  å¤§å°: ${{ env.FIRMWARE_SIZE }}"
          echo "  æ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}"
          echo ""
          echo "ğŸ”— ä¸‹è½½é“¾æ¥:"
          echo "  Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  Releases: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.release_tag }}"
          echo ""
          echo "ğŸ“ ç¼–è¯‘æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµç¨‹è®°å½•
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 5
          token: ${{ secrets.GITHUB_TOKEN }}

# ç¼–è¯‘å¤±è´¥å¤„ç†
  failure_handler:
    runs-on: ubuntu-24.04
    needs: [prepare, build]
    if: failure()
    name: âŒ ç¼–è¯‘å¤±è´¥å¤„ç†
    
    steps:
      - name: ğŸ“ ç”Ÿæˆå¤±è´¥æŠ¥å‘Š
        run: |
          echo "âŒ OpenWrtç¼–è¯‘å¤±è´¥"
          echo "ğŸ“‹ å¤±è´¥ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_branch }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.target_device }}"
          echo "  æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}"
          echo "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ” å¯èƒ½çš„å¤±è´¥åŸå› :"
          echo "  1. æ’ä»¶é…ç½®å†²çª"
          echo "  2. è®¾å¤‡å­˜å‚¨ç©ºé—´ä¸è¶³"
          echo "  3. ç½‘ç»œè¿æ¥é—®é¢˜"
          echo "  4. æºç æˆ–ä¾èµ–åŒ…é—®é¢˜"
          echo ""
          echo "ğŸ“– è§£å†³å»ºè®®:"
          echo "  1. æ£€æŸ¥æ’ä»¶å†²çªæ£€æµ‹ç»“æœ"
          echo "  2. å‡å°‘é€‰æ‹©çš„æ’ä»¶æ•°é‡"
          echo "  3. é€‰æ‹©æ›´ç¨³å®šçš„æºç åˆ†æ”¯"
          echo "  4. æŸ¥çœ‹è¯¦ç»†çš„ç¼–è¯‘æ—¥å¿—"
          echo ""
          echo "ğŸ”— ç¼–è¯‘æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
# ç¼–è¯‘æˆåŠŸå¤„ç†
  success_handler:
    runs-on: ubuntu-24.04
    needs: [prepare, build]
    if: success()
    name: âœ… ç¼–è¯‘æˆåŠŸå¤„ç†
    
    steps:
      - name: ğŸ‰ ç”ŸæˆæˆåŠŸæŠ¥å‘Š
        run: |
          echo "ğŸ‰ OpenWrtç¼–è¯‘æˆåŠŸå®Œæˆ!"
          echo "ğŸ“¦ å›ºä»¶ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_branch }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.target_device }}"
          echo "  æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}"
          echo "  æ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}"
          echo "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "  1. GitHub Actions Artifacts (7å¤©æœ‰æ•ˆæœŸ)"
          echo "  2. GitHub Releases (é•¿æœŸä¿å­˜)"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - Actions: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  - Releases: https://github.com/${{ github.repository }}/releases"
          echo "  - é¡¹ç›®ä¸»é¡µ: https://github.com/${{ github.repository }}"